"use strict";!function(t){function e(){t(o).addClass("sb-collapsing"),setTimeout(function(){t(o).removeClass("sb-collapsing")},1e3)}function s(t){if(void 0===t)return window.sb_current_user;window.sb_current_user=t}function i(t){return SBF.translate(t)}function n(){0!=s()&&t(v).setProfile("#"==s().get("last_name").charAt(0)?i("Account"):s().name)}function a(e=!1){let i="";i=e&&"title"in e.details&&!SBF.null(e.details.title)?e.get("title"):SBF.setting("tickets-conversation-name"),t(g).html(""==i||-1==i?s().name:i)}var o,l,r,c,d,b,f,g,h,v,u,m={},p={},S=t(window).width()<426,B={showPanel:function(e="",s=!1){let n=b;switch(b=e,t(o).addClass("sb-panel-active sb-load").removeClass("sb-panel-form").attr("data-panel",e),e){case"privacy":SBF.ajax({function:"get-block-setting",value:"privacy"},e=>{t(g).html(i(e.title)),t(c).append(`<div class="sb-privacy sb-init-form" data-decline="${i(e.decline.replace(/"/g,""))}"><div class="sb-text">${i(e.message)}</div>`+(""!=e.link?`<a target="_blank" href="${e.link}">${i(e["link-name"])}</a>`:"")+`<div class="sb-buttons"><a class="sb-btn sb-approve">${i(e["btn-approve"])}</a><a class="sb-btn sb-decline">${i(e["btn-decline"])}</a></div></div>`)}),this.showSidePanels(!1);break;case"articles":t(g).html(i(0==s?"Articles":s)),this.showSidePanels(!1);break;case"edit-profile":case"login":case"registration":let f="edit-profile"==e;this.showSidePanels(!1),t(o).addClass("sb-panel-form"),e in p?(t(c).html(p[e]),t(g).html(i(t(c).find(".sb-top").html()))):(SBF.ajax({function:"get-rich-message",name:(f?"registration":e)+"-tickets"},s=>{t(c).html(s);let n=t(c).find(".sb-top").html();f&&t(c).find(".sb-top").html(i("Edit profile")),t(g).html(i(n)),setTimeout(function(){t(g).html(i(n))},300),t(c).find(".sb-link-area").insertAfter(".sb-buttons"),t(c).find(".sb-info").insertBefore(".sb-buttons"),p[e]=t(c).html()}),t(c).html('<div class="sb-loading"></div>'));break;case"new-ticket":this.showSidePanels(!1),t(g).html(i("Create a new ticket")),t(c).html(`<div class="sb-info"></div><div class="sb-input sb-input-text sb-ticket-title"><span>${i("Title")}</span><input type="text" required></div>${t(o).find(".sb-ticket-fields").html()}<div class="sb-input sb-editor-cnt"><span>${i("Message")}</span></div><div class="sb-btn sb-icon sb-create-ticket"><i class="sb-icon-plus"></i>${i("Create Ticket")}</div>`),t(l).find(".sb-editor-cnt").append(d);break;default:this.showSidePanels(!0),"new-ticket"==n&&(t(d).removeClass("sb-error"),t(d).find("textarea").val(""),t(d).find(".sb-bar").sbActivate(!1),t(r).after(d)),t(c).html(""),t(o).removeClass("sb-panel-active sb-load").removeAttr("data-panel"),a(SBChat.conversation)}SBF.event("SBPanelActive",e),setTimeout(function(){t(o).removeClass("sb-load")},300)},showSidePanels:function(s=!0){let i=t(o).find(".sb-btn-collapse");e(),!s||u>800?t(o).find(".sb-panel-left,.sb-panel-right").setClass("sb-collapsed",!s):u<=800&&t(i).sbActivate(),t(i).css("display",s?"":"none")},setAgent:function(e){let s=t(o).find(".sb-agent-label").sbActivate(!1);if(SBChat.agent_id=e,e in m){let i=m[e];t(h).setProfile(i.name,i.image).sbActivate(),"details"in i&&SBF.getLocationTimeString(i.extra,e=>{t(s).html((""!=i.get("flag")?`<img src="${SB_URL}/media/flags/${i.get("flag")}">`:'<i class="sb-icon sb-icon-marker"></i>')+e).sbActivate()})}else SBF.ajax({function:"get-agent",agent_id:e},t=>{0!=t&&(m[e]=new SBUser(t),this.setAgent(e))})},activateConversation:function(e){if(e instanceof SBConversation){let n=SBChat.lastAgent(),l=["id","creation_time","last_update"],c="";this.selectConversation(e.id),a(e),t(o).find(".sb-panel-right .sb-scroll-area > div").sbActivate(!1),0!=n?(t(h).setProfile(n.full_name,n.profile_image),this.setAgent(n.user_id),setTimeout(function(){SBChat.updateUsersActivity()},300)):t(h).sbActivate(!1),""!=e.get("department")&&SBChat.getDepartmentCode(e.get("department"),e=>{let s=t(o).find(".sb-department");t(s).html(`<span class="sb-title">${t(s).data("label")}</span>${e}`).sbActivate()});for(s=0;s<l.length;s++){let t;switch(l[s]){case"id":t=["padlock",i("Ticket ID"),e.id];break;case"creation_time":t=["calendar",i("Creation time"),SBF.beautifyTime(e.get("creation_time"),!0)];break;case"last_update":t=["reload",i("Last update"),SBF.beautifyTime(0==e.getLastMessage()?e.get("creation_time"):e.getLastMessage().get("creation_time"),!0)]}c+=`<div data-id="${l[s]}"><i class="sb-icon sb-icon-${t[0]}"></i><span>${t[1]}</span><div>${t[2]}</div></div>`}t(o).find(".sb-ticket-details").html(c);let d=e.getAttachments();c="";for(var s=0;s<d.length;s++)c+=`<a href="${d[s][1]}" target="_blank"><i class="sb-icon sb-icon-file"></i>${d[s][0]}</a>`;t(o).find(".sb-conversation-attachments").html((""==c?"":`<div class="sb-title">${i("Attachments")}</div>`)+c),t(r).sbLoading(!1)}else SBF.error("Value not of type SBConversation","activateConversation")},selectConversation:function(e){let s=t(f).find(`[data-conversation-id="${e}"]`);t(f).find("> li").sbActivate(!1),1==t(s).attr("data-conversation-status")&&t(s).attr("data-conversation-status",0),t(s).sbActivate()},getActiveConversation:function(e=""){let s=t(f).find(" > .sb-active");return s.length?"ID"==e?t(s).attr("data-conversation-id"):s:-1},welcome:function(){SBF.setting("tickets-welcome-active")&&!SBF.storage("tickets-welcome")&&setTimeout(()=>{SBChat.sendMessage(SBF.setting("bot-id"),SBF.setting("tickets-welcome-message")),SBF.storage("tickets-welcome",!0)},1e3)},init:function(){if(o=t("body").find(".sb-tickets"),l=t(o).find(" > div > .sb-panel-main"),c=t(l).find(".sb-panel"),d=t(l).find(".sb-editor"),g=t(l).find(" > .sb-top .sb-title"),f=t(o).find(".sb-user-conversations"),r=t(l).find(".sb-list"),h=t(o).find(".sb-profile-agent"),v=t(o).find(".sb-panel-right > .sb-top .sb-profile"),u=t(o).width(),t(o).on("click",".sb-btn-collapse",function(){e(),t(o).find(".sb-panel-"+(t(this).hasClass("sb-left")?"left":"right")).toggleClass("sb-collapsed"),t(this).toggleClass("sb-active")}),t(d).on("focus focusout","textarea",function(){t(this).parent().parent().toggleClass("sb-focus")}),S||(t(d).on("click",".sb-btn-emoji",function(){let e="new-ticket"==b?[c,"padding-top",415]:[o,"margin-top",335];if(t(d).find(".sb-emoji").sbActive()){let s=t(this).offset().top+t(e[0])[0].scrollTop-window.scrollY,i=t(o).offset().top-window.scrollY;s-i<380&&t(e[0]).css(e[1],e[2]-(s-i)+"px")}else t(e[0]).css(e[1],"")}),t(d).on("click",".sb-emoji-list > ul > li",function(){let e="new-ticket"==b?[c,"padding-top",415]:[o,"margin-top",335];t(e[0]).css(e[1],"")})),t(l).on("click","> .sb-top .sb-close",function(){B.showPanel()}),t(l).on("click",".sb-create-ticket",function(){let e=!1;if(t(d).removeClass("sb-error"),SBForm.errors(c)&&(SBForm.showErrorMessage(c,"Please fill in all the required fields."),e=!0),""==t(d).find("textarea").val().trim()&&(e||SBForm.showErrorMessage(c,"Please write a message."),t(d).addClass("sb-error"),e=!0),!e&&!SBChat.is_busy){let e="",a=SBForm.getAll(c),o="department"in a?a.department[0]:null;SBChat.clear(),SBChat.activateBar(!1);for(var n in a)""!=a[n][1]&&""!=a[n][0]&&(e+=`*${i(a[n][1])}*\n${a[n][0]}\n\n`);e+=t(d).find("textarea").val().trim(),s()?SBChat.newConversation(2,-1,e,[],o,null,function(){B.welcome()}):SBChat.addUserAndLogin(()=>{SBChat.newConversation(2,-1,e,[],o,null,function(){B.welcome()})})}}),t(o).on("click",".sb-new-ticket",function(){B.showPanel("new-ticket")}),t(f).on("click","li",function(){SBChat.clear(),B.selectConversation(t(this).attr("data-conversation-id")),t(r).sbLoading(!0),S&&t(o).find(".sb-panel-left").addClass("sb-collapsed")}),t(o).find(".sb-panel-left .sb-search-btn input").on("input",function(){let e=t(this).val();SBF.search(e,()=>{e.length>1?SBF.ajax({function:"search-user-conversations",search:e},e=>{let i=[];for(var n=0;n<e.length;n++)i.push(new SBConversation([new SBMessage(e[n])],{id:e[n].conversation_id,title:e[n].title,conversation_status_code:e[n].conversation_status_code}));t(f).html(s().getConversationsCode(i))}):SBChat.populateConversations()})}),t(o).on("click",".sb-panel-left .sb-search-btn i",function(){SBF.searchClear(this,function(){SBChat.populateConversations()})}),t(c).on("click",".sb-login-area",function(){B.showPanel("login")}),t(c).on("click",".sb-registration-area",function(){B.showPanel("registration")}),t(o).on("click",'.sb-profile-menu [data-value="edit-profile"]',function(){B.showPanel("edit-profile")}),t(o).on("click",'.sb-profile-menu [data-value="logout"]',function(){SBF.logout(!1),B.showPanel("login")}),t(c).on("click",".sb-submit",function(){if(!t(this).sbLoading()){let e=SBForm.getAll(c),i=SBForm.getAll(c.find(".sb-form-extra")),a="edit-profile"==b;SBForm.errors(c)?SBForm.showErrorMessage(c,SBForm.getRegistrationErrorMessage(c)):(t(this).sbLoading(!0),SBF.ajax({function:a||s()?"update-user":"add-user-and-login",settings:e,settings_extra:i},i=>{0==i||SBF.errorValidation(i)?SBForm.showErrorMessage(c,SBForm.getRegistrationErrorMessage(i,"response")):(0==s()?s(new SBUser(i[0])):s().details=i[0],SBF.loginCookie(i[1]),n(),a?B.showPanel():(SBF.event("SBRegistrationForm",{user:e}),SBF.event("SBNewEmailAddress",{name:s().name,email:s().get("email")}),B.showPanel("new-ticket"))),t(this).sbLoading(!1)}))}}),t(c).on("click",".sb-submit-login",function(){SBF.loginForm(this,c,e=>{s(new SBUser(e[0])),n(),SBChat.populateConversations(e=>{0==e.length?(t(o).addClass("sb-no-conversations"),B.showPanel("new-ticket")):(SBChat.openConversation(e[0].id),B.showPanel())})})}),!o.length)return;if(!SBF.setting("tickets-registration-required")||s()&&!["visitor","lead"].includes(s().type))SBF.setting("welcome")||s()&&0!=s().conversations?s().conversations.length&&-1==B.getActiveConversation()?SBChat.openConversation(SBF.getURL("conversation")?SBF.getURL("conversation"):s().conversations[0].id):SBF.setting("welcome")&&a():(t(o).addClass("sb-no-conversations"),SBF.setting("privacy")&&!SBF.storage("privacy-approved")?B.showPanel("privacy"):B.showPanel("new-ticket"));else{let e=SBF.setting("tickets-registration-redirect");""!=e?document.location=e:(t(o).addClass("sb-no-conversations"),B.showPanel(SBF.setting("tickets-default-form")))}let m=parseInt(SBF.null(t(o).data("height"))?t(window).height():t(o).data("height")),p=parseInt(SBF.null(t(o).data("offset"))?0:t(o).data("offset"));u<=800?(t(o).addClass("sb-800"),t(o).find(".sb-panel-left,.sb-panel-right").addClass("sb-collapsed"),t(o).find(".sb-btn-collapse").sbActivate()):u<=1e3?t(o).addClass("sb-1000"):u<=1300&&t(o).addClass("sb-1300"),n(),t(o).removeClass("sb-loading").find(".sb-tickets-area").attr("style",`height: ${m-p}px`),setTimeout(function(){t(o).removeClass("sb-load")},300),SBChat.startRealTime(),SBF.event("SBTicketsInit")},onMessageSent:function(){if("new-ticket"==b){let e=t(l).find(".sb-ticket-title input").val();SBChat.updateConversations(),t(o).find(".sb-panel-right .sb-scroll-area > div").sbActivate(!1),t(o).find(".sb-conversation-attachments,.sb-ticket-details").html(""),t(o).removeClass("sb-no-conversations"),B.showPanel(),t(g).html(e)}},onNewConversationReceived:function(t){t.id==SBChat.conversation.id&&B.getActiveConversation("ID")!=t.id&&setTimeout(function(){B.activateConversation(SBChat.conversation)},300)},onNewMessageReceived:function(e){if(e instanceof SBMessage&&e.get("conversation_id")==SBChat.conversation.id){let s=SBChat.lastAgent();t(B.getActiveConversation()).html(SBChat.conversation.getCode()),0!=s&&SBF.isAgent(e.get("user_type"))&&s.id!=e.get("user_id")&&B.setAgent(e.get("user_id"))}}};window.SBTickets=B,SBF.null(t.fn.setProfile)&&(t.fn.sbActivate=function(e=!0){return t(this).setClass("sb-active",e),this},t.fn.sbActive=function(){return t(this).hasClass("sb-active")},t.fn.sbLoading=function(e="check"){return"check"==e?t(this).hasClass("sb-loading"):(t(this).setClass("sb-loading",e),this)},t.fn.setProfile=function(e=!1,i=!1){return SBF.null(e)&&(e=0!=s()?s().name:""),SBF.null(i)&&(i=0!=s()?s().image:SB_URL+"/media/user.svg"),t(this).find("img").attr("src",i),t(this).find(".sb-name").html(e),this},t.fn.setClass=function(e,s=!0){s?t(this).addClass(e):t(this).removeClass(e)})}(jQuery);